<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Otra Mente - Calibración Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link rel="stylesheet" href="styles.css">
    <style>
        .dragover {
            border-color: #22c55e !important;
            background-color: rgba(34, 197, 94, 0.1);
        }

        #visualizer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s;
        }

        .visualizer-active #visualizer {
            opacity: 1;
        }

        .hidden-video {
            opacity: 0;
            pointer-events: none;
            position: absolute;
        }

        /* Camera Visibility */
        #webcam {
            opacity: 1;
            transition: opacity 0.5s;
            z-index: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        /* Hide camera when visualizer is active (eyes closed) */
        body.visualizer-active #webcam {
            opacity: 0;
        }
    </style>
</head>

<body class="h-screen w-screen flex flex-col relative bg-black overflow-hidden select-none">

    <div class="scan-line"></div>

    <!-- PANTALLA DE CARGA -->
    <div id="loading-screen" class="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-green-500 text-sm animate-pulse tracking-widest">SISTEMA INICIANDO...</p>
        <p id="loading-status" class="text-xs text-gray-500 mt-2 font-mono">Cargando modelos neuronales...</p>
    </div>

    <!-- PANTALLA DE INICIO -->
    <div id="home-screen" class="hidden flex-1 flex flex-col items-center justify-center space-y-8 p-6 z-20">
        <h1
            class="text-4xl font-bold tracking-[0.5em] text-center uppercase text-white mb-4 drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]">
            NEURAL ECHO</h1>

        <div class="flex flex-col w-full max-w-xs gap-6 z-30">
            <button onclick="goToUpload()"
                class="border border-green-800 text-green-500 hover:bg-green-900/30 hover:border-green-500 py-4 px-6 rounded font-bold transition duration-300 font-mono text-sm tracking-wider">
                [+] SUBIR MEMORIA
            </button>
            <button onclick="startCalibrationFlow()"
                class="bg-white text-black hover:bg-gray-300 hover:scale-105 py-4 px-6 rounded font-bold transition duration-300 tracking-widest shadow-lg shadow-white/20">
                INICIAR VÓRTICE
            </button>
        </div>
        <p id="track-info" class="text-xs text-gray-600 font-mono mt-8"></p>
    </div>

    <!-- PANTALLA DE SUBIDA -->
    <div id="upload-screen" class="hidden absolute inset-0 z-30 bg-black flex flex-col items-center justify-center p-6">
        <h2 class="text-xl mb-8 text-green-400 font-mono tracking-widest">GRABAR NUEVA MEMORIA</h2>

        <div id="record-zone" class="flex flex-col items-center gap-6 mb-8 w-full max-w-xs">
            <div id="record-status" class="text-gray-500 font-mono text-xs tracking-wider h-6">LISTO PARA GRABAR</div>

            <div class="relative w-24 h-24 flex items-center justify-center">
                <!-- Recording Pulse Animation -->
                <div id="record-pulse" class="absolute w-full h-full rounded-full bg-red-600/20 animate-ping hidden">
                </div>

                <button id="record-btn"
                    class="w-20 h-20 rounded-full bg-red-600 hover:bg-red-500 flex items-center justify-center transition-all shadow-lg hover:shadow-red-500/50 z-10 transform hover:scale-105 active:scale-95">
                    <div class="w-8 h-8 bg-white rounded-full"></div>
                </button>

                <button id="stop-btn"
                    class="hidden w-20 h-20 rounded-full bg-gray-800 hover:bg-gray-700 flex items-center justify-center border-2 border-red-500 z-10 transition-all transform hover:scale-105 active:scale-95 shadow-[0_0_20px_rgba(220,38,38,0.3)]">
                    <div class="w-8 h-8 bg-red-500 rounded-sm"></div>
                </button>
            </div>

            <audio id="audio-preview" controls
                class="hidden w-full h-10 mt-4 opacity-80 hover:opacity-100 transition rounded bg-white/5"></audio>
        </div>

        <button id="upload-btn" disabled
            class="bg-green-900/50 text-gray-400 px-8 py-3 rounded font-bold font-mono text-sm transition-all mb-4 border border-green-900/30 hover:bg-green-800 hover:text-white hover:border-green-500 disabled:opacity-30 disabled:pointer-events-none shadow-lg">
            TRANSMITIR A LA NUBE
        </button>

        <p id="upload-status" class="text-xs font-mono text-gray-400 h-4"></p>

        <button onclick="goHome()"
            class="absolute top-8 left-8 text-gray-500 hover:text-white font-mono text-xs transition">← VOLVER</button>
    </div>

    <!-- PANTALLA DE CALIBRACIÓN -->
    <div id="calibration-screen"
        class="hidden absolute inset-0 z-40 bg-black flex flex-col items-center justify-center text-center p-4">
        <h2 class="text-xl text-green-500 mb-2 font-mono">CALIBRACIÓN RETINAL</h2>
        <p id="calib-instruction" class="text-white text-lg font-bold mb-8 h-16 transition-colors duration-300">
            ...
        </p>

        <div class="relative w-64 h-48 border border-green-900/50 rounded overflow-hidden mb-6 bg-gray-900">
            <canvas id="calib-canvas" class="w-full h-full object-cover transform scale-x-[-1]"></canvas>
            <div id="face-indicator"
                class="absolute top-2 right-2 w-2 h-2 rounded-full bg-red-900 transition-colors duration-200"></div>
        </div>

        <div id="calib-progress" class="w-64 h-1 bg-gray-900 rounded mb-8 hidden overflow-hidden">
            <div id="calib-bar" class="h-full bg-green-500 w-0 transition-all duration-100 ease-linear"></div>
        </div>

        <button id="start-calib-btn" onclick="runCalibration()"
            class="hidden bg-white text-black px-10 py-3 rounded hover:bg-gray-200 font-bold tracking-widest transition shadow-[0_0_15px_rgba(255,255,255,0.3)]">
            COMENZAR
        </button>
    </div>

    <!-- PANTALLA DE EXPERIENCIA -->
    <div id="experience-screen"
        class="hidden absolute inset-0 z-40 bg-black flex flex-col items-center justify-center text-center overflow-hidden">

        <!-- Visualizador de Audio (Ojos Cerrados) -->
        <canvas id="visualizer"></canvas>

        <!-- Contenedor Principal de Estado -->
        <div id="status-container" class="z-50 pointer-events-none transition-all duration-700 opacity-100">
            <h2 id="status-text"
                class="text-2xl font-bold text-red-600 tracking-[0.5em] animate-pulse drop-shadow-[0_0_5px_rgba(255,0,0,0.8)]">
                OJOS ABIERTOS
            </h2>
        </div>

        <!-- Debug Info (Muy discreto) -->
        <div
            class="absolute bottom-2 left-2 text-left pointer-events-none z-50 opacity-20 hover:opacity-100 transition-opacity">
            <p id="debug-ear" class="text-[9px] font-mono text-green-500">EAR: 0.00</p>
            <p id="debug-rot" class="text-[9px] font-mono text-green-500">ROT: 0.00</p>
        </div>

        <!-- Elementos técnicos ocultos -->
        <canvas id="output" class="hidden-video transform scale-x-[-1]"></canvas>
        <video id="webcam" autoplay playsinline muted class="hidden-video"></video>

        <button onclick="stopExperience()"
            class="absolute top-6 right-6 text-gray-700 text-[10px] border border-gray-800 px-3 py-1 rounded hover:text-white hover:border-white transition z-50 pointer-events-auto font-mono">
            ABORT
        </button>
    </div>

    <script src="script.js"></script>
</body>

</html>